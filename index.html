<script>
    // DOM Elements
    const fbstateInput = document.getElementById('fbstate');
    const verifyBtn = document.getElementById('verifyBtn');
    const authStatus = document.getElementById('authStatus');
    const authStatusText = document.getElementById('authStatusText');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const terminal = document.getElementById('terminal');
    
    // State variables
    let isAuthenticated = false;
    let isRunning = false;
    let abortController = null;
    
    // Add a line to the terminal
    function addTerminalLine(text, className = '') {
        const line = document.createElement('p');
        line.className = `terminal-line ${className}`;
        line.textContent = `> ${text}`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
    }
    
    // Verify FBState
    verifyBtn.addEventListener('click', async () => {
        const fbstate = fbstateInput.value.trim();
        
        if (!fbstate) {
            addTerminalLine('Error: FBState token required', 'error');
            return;
        }
        
        addTerminalLine('Verifying FBState token...', 'warning');
        
        // Simulate verification (in a real app, you'd call your API)
        try {
            // This is where you would normally verify the fbstate
            // For demo purposes, we'll just simulate it
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Randomly succeed or fail for demo
            const success = Math.random() > 0.2;
            
            if (success) {
                isAuthenticated = true;
                startBtn.disabled = false;
                authStatus.style.display = 'block';
                authStatusText.textContent = 'Authentication successful. Systems online.';
                authStatusText.className = 'success';
                addTerminalLine('Authentication successful. Systems online.', 'success');
            } else {
                throw new Error('Invalid FBState token');
            }
        } catch (error) {
            isAuthenticated = false;
            startBtn.disabled = true;
            authStatus.style.display = 'block';
            authStatusText.textContent = `Error: ${error.message}`;
            authStatusText.className = 'error';
            addTerminalLine(`Error: ${error.message}`, 'error');
        }
    });
    
    // Start sharing
    startBtn.addEventListener('click', async () => {
        if (!isAuthenticated) {
            addTerminalLine('Error: Not authenticated', 'error');
            return;
        }
        
        const postUrl = document.getElementById('postUrl').value.trim();
        const shareCount = parseInt(document.getElementById('shareCount').value);
        const delayMin = parseInt(document.getElementById('delayMin').value);
        const delayMax = parseInt(document.getElementById('delayMax').value);
        const shareType = document.getElementById('shareType').value;
        const customMessage = document.getElementById('customMessage').value.trim();
        
        if (!postUrl) {
            addTerminalLine('Error: Post URL required', 'error');
            return;
        }
        
        if (isRunning) {
            addTerminalLine('Mission already in progress', 'warning');
            return;
        }
        
        isRunning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        abortController = new AbortController();
        
        addTerminalLine(`Initiating deployment to ${postUrl}`, 'info');
        addTerminalLine(`Parameters: ${shareCount} shares, ${delayMin}-${delayMax}s delay`, 'info');
        
        try {
            for (let i = 0; i < shareCount; i++) {
                if (abortController.signal.aborted) {
                    addTerminalLine('Mission aborted by user', 'warning');
                    break;
                }
                
                // Simulate sharing (in a real app, you'd call your API)
                const delay = Math.floor(Math.random() * (delayMax - delayMin + 1)) + delayMin;
                
                addTerminalLine(`Share ${i + 1}/${shareCount}: Processing...`, 'info');
                
                await new Promise(resolve => {
                    setTimeout(() => {
                        // Randomly succeed or fail for demo
                        const success = Math.random() > 0.8;
                        
                        if (success) {
                            addTerminalLine(`Share ${i + 1}/${shareCount}: Successfully deployed`, 'success');
                        } else {
                            addTerminalLine(`Share ${i + 1}/${shareCount}: Encountered resistance`, 'warning');
                        }
                        
                        resolve();
                    }, delay * 1000);
                });
            }
            
            addTerminalLine('Mission completed successfully', 'success');
        } catch (error) {
            addTerminalLine(`Error: ${error.message}`, 'error');
        } finally {
            isRunning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            abortController = null;
        }
    });
    
    // Stop sharing
    stopBtn.addEventListener('click', () => {
        if (abortController) {
            abortController.abort();
            addTerminalLine('Abort signal sent...', 'warning');
        }
    });
    
    // Initial terminal message
    setTimeout(() => {
        addTerminalLine('Booting cyber modules...', 'info');
    }, 500);
    
    setTimeout(() => {
        addTerminalLine('Network interfaces activated', 'info');
    }, 1500);
</script>
